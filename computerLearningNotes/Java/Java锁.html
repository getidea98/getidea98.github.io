<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Java锁 | getidea98</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="个人博客">
    
    <link rel="preload" href="/assets/css/0.styles.7f84f354.css" as="style"><link rel="preload" href="/assets/js/app.10cb8224.js" as="script"><link rel="preload" href="/assets/js/2.74aa129f.js" as="script"><link rel="preload" href="/assets/js/16.bf2ec8b1.js" as="script"><link rel="prefetch" href="/assets/js/10.dadb40c9.js"><link rel="prefetch" href="/assets/js/11.cf4190a3.js"><link rel="prefetch" href="/assets/js/12.0824368c.js"><link rel="prefetch" href="/assets/js/13.9bf75953.js"><link rel="prefetch" href="/assets/js/14.94f39f3c.js"><link rel="prefetch" href="/assets/js/15.66b03d5f.js"><link rel="prefetch" href="/assets/js/17.185e3bce.js"><link rel="prefetch" href="/assets/js/18.8e115374.js"><link rel="prefetch" href="/assets/js/19.0f1a594a.js"><link rel="prefetch" href="/assets/js/20.b52cba55.js"><link rel="prefetch" href="/assets/js/21.a70fb2fa.js"><link rel="prefetch" href="/assets/js/22.c9eade7d.js"><link rel="prefetch" href="/assets/js/23.27964abf.js"><link rel="prefetch" href="/assets/js/24.7e7113f1.js"><link rel="prefetch" href="/assets/js/25.76d5253a.js"><link rel="prefetch" href="/assets/js/26.a22db28f.js"><link rel="prefetch" href="/assets/js/27.be3b5979.js"><link rel="prefetch" href="/assets/js/28.ccb2467c.js"><link rel="prefetch" href="/assets/js/29.c2c97391.js"><link rel="prefetch" href="/assets/js/3.ed25f37c.js"><link rel="prefetch" href="/assets/js/30.dd5a03c2.js"><link rel="prefetch" href="/assets/js/31.2a1a51a4.js"><link rel="prefetch" href="/assets/js/32.77b782f6.js"><link rel="prefetch" href="/assets/js/33.d09b68b5.js"><link rel="prefetch" href="/assets/js/34.93280e54.js"><link rel="prefetch" href="/assets/js/4.f154c237.js"><link rel="prefetch" href="/assets/js/5.9824d715.js"><link rel="prefetch" href="/assets/js/6.3205172c.js"><link rel="prefetch" href="/assets/js/7.a0f0b63a.js"><link rel="prefetch" href="/assets/js/8.173a1f72.js"><link rel="prefetch" href="/assets/js/9.d82ab73f.js">
    <link rel="stylesheet" href="/assets/css/0.styles.7f84f354.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="https://cn.vuejs.org/images/logo.svg" alt="getidea98" class="logo"> <span class="site-name can-hide">getidea98</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/computerLearningNotes/Java/ArrayList/" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/DesignPattern.html" class="nav-link">
  设计模式
</a></div><div class="nav-item"><a href="/computerBase/Linux.html" class="nav-link">
  计算机基础
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">读书笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">读书笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/studyBook/TheArtOfJavaConcurrentProgramming/" class="nav-link">
  Java并发编程的艺术
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/computerLearningNotes/Java/ArrayList/" class="nav-link">
  Java
</a></div><div class="nav-item"><a href="/DesignPattern.html" class="nav-link">
  设计模式
</a></div><div class="nav-item"><a href="/computerBase/Linux.html" class="nav-link">
  计算机基础
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Language Menu" class="dropdown-title"><span class="title">读书笔记</span> <span class="arrow down"></span></button> <button type="button" aria-label="Language Menu" class="mobile-dropdown-title"><span class="title">读书笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/studyBook/TheArtOfJavaConcurrentProgramming/" class="nav-link">
  Java并发编程的艺术
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Java</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/computerLearningNotes/Java/ArrayList.html" class="sidebar-link">ArrayList</a></li><li><a href="/computerLearningNotes/Java/HashMap.html" class="sidebar-link">HashMap</a></li><li><a href="/computerLearningNotes/Java/Java动态代理.html" class="sidebar-link">动态代理</a></li><li><a href="/computerLearningNotes/Java/Java反射与注解.html" class="sidebar-link">Java反射与注解</a></li><li><a href="/computerLearningNotes/Java/Java锁.html" class="active sidebar-link">Java锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/computerLearningNotes/Java/Java锁.html#悲观锁与乐观锁" class="sidebar-link">悲观锁与乐观锁</a></li><li class="sidebar-sub-header"><a href="/computerLearningNotes/Java/Java锁.html#锁升级" class="sidebar-link">锁升级</a></li></ul></li><li><a href="/computerLearningNotes/Java/Thread多线程.html" class="sidebar-link">Thread多线程</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="java锁"><a href="#java锁" class="header-anchor">#</a> Java锁</h1> <p>tag: Java基础</p> <h2 id="悲观锁与乐观锁"><a href="#悲观锁与乐观锁" class="header-anchor">#</a> 悲观锁与乐观锁</h2> <p><strong>悲观锁：读写都会加锁。因此适合在写数据多的情况。</strong></p> <p><strong>乐观锁：读数据不会加锁，写数据才会加锁。因此适合读多写少的情况。</strong></p> <h3 id="悲观锁"><a href="#悲观锁" class="header-anchor">#</a> 悲观锁：</h3> <p>Java的synchronized和Lock就是悲观锁。</p> <h3 id="乐观锁"><a href="#乐观锁" class="header-anchor">#</a> 乐观锁：</h3> <p>乐观锁在Java中是通过无锁编程实现的。原子类的递增操作就是通过CAS自旋实现的。</p> <p><strong>CAS:</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">AtomicInteger</span> atomicInteger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        atomicInteger<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token comment">// AtomicInteger</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> unsafe<span class="token punctuation">.</span><span class="token function">getAndAddInt</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> valueOffset<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token comment">// Unsafe</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token function">getAndAddInt</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">,</span> <span class="token keyword">long</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> delta<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> v<span class="token punctuation">;</span>
        <span class="token keyword">do</span> <span class="token punctuation">{</span>
            v <span class="token operator">=</span> <span class="token function">getIntVolatile</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">compareAndSwapInt</span><span class="token punctuation">(</span>o<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> v<span class="token punctuation">,</span> v <span class="token operator">+</span> delta<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> v<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>CAS在实现有问题，那就是ABA问题。解决办法是变量前面加版本号。</p> <h3 id="自旋锁与自适应自旋锁"><a href="#自旋锁与自适应自旋锁" class="header-anchor">#</a> 自旋锁与自适应自旋锁</h3> <p>线程获取不到锁有两种处理方式：1. 线程阻塞 2.线程自旋</p> <p>自旋锁：线程获取不到锁的时候，循环的执行空代码。</p> <p>自适应自旋锁：循环次数不是固定的，而是由上次循环情况和锁的拥有者的状态决定。</p> <p>线程一旦被阻塞，再次被唤醒时代价较大。因此适当的采用自旋锁可以提高效率。</p> <h3 id="独享锁与共享锁"><a href="#独享锁与共享锁" class="header-anchor">#</a> 独享锁与共享锁</h3> <p>独享锁也叫排他锁、互斥锁，是指该锁一次只能被一个线程所持有。如果线程T对数据A加上排它锁后，则其他线程不能再对A加任何类型的锁。</p> <p>共享锁是指该锁可被多个线程所持有。如果线程T对数据A加上共享锁后，则其他线程只能对A再加共享锁，不能加排它锁。获得共享锁的线程只能读数据，不能修改数据。</p> <h3 id="可重入锁-vs-非可重入锁"><a href="#可重入锁-vs-非可重入锁" class="header-anchor">#</a> 可重入锁 VS 非可重入锁</h3> <h3 id="公平锁-vs-非公平锁"><a href="#公平锁-vs-非公平锁" class="header-anchor">#</a> 公平锁 VS 非公平锁</h3> <h2 id="锁升级"><a href="#锁升级" class="header-anchor">#</a> 锁升级</h2> <h3 id="无锁-vs-偏向锁-vs-轻量级锁-vs-重量级锁"><a href="#无锁-vs-偏向锁-vs-轻量级锁-vs-重量级锁" class="header-anchor">#</a> 无锁 VS 偏向锁 VS 轻量级锁 VS 重量级锁</h3> <p>针对synchronized锁的四种状态。</p> <p><strong>偏向锁</strong></p> <p>通过对比Mark Word中的信息，判断当前线程是否拥有当前对象锁，避免通过CAS原子操作。</p> <p>拥有偏向锁的线程只需要和MarkWord里的信息对比下，然后执行。</p> <p><strong>轻量级锁</strong></p> <p>是指当锁是偏向锁的时候，被另外的线程所访问，偏向锁就会升级为轻量级锁，其他线程会通过自旋的形式尝试获取锁，不会阻塞，从而提高性能。</p> <p><strong>重量级锁</strong></p> <p>若当前只有一个等待线程，则该线程通过自旋进行等待。但是当自旋超过一定的次数，或者一个线程在持有锁，一个在自旋，又有第三个来访时，轻量级锁升级为重量级锁。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/computerLearningNotes/Java/Java反射与注解.html" class="prev">
        Java反射与注解
      </a></span> <span class="next"><a href="/computerLearningNotes/Java/Thread多线程.html">
        Thread多线程
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.10cb8224.js" defer></script><script src="/assets/js/2.74aa129f.js" defer></script><script src="/assets/js/16.bf2ec8b1.js" defer></script>
  </body>
</html>
